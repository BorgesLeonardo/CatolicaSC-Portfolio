name: SonarQube Analysis

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'backend/**'
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'backend/**'
  workflow_dispatch:

env:
  NODE_VERSION: '20.x'
  BACKEND_DIR: './backend'

jobs:
  sonarqube:
    name: SonarQube Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Shallow clones should be disabled for better analysis

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: ${{ env.BACKEND_DIR }}/package-lock.json

      - name: ğŸ“¦ Install dependencies
        working-directory: ${{ env.BACKEND_DIR }}
        run: npm ci

      - name: ğŸ” Run ESLint
        working-directory: ${{ env.BACKEND_DIR }}
        run: npm run lint

      - name: ğŸ’… Check Prettier formatting
        working-directory: ${{ env.BACKEND_DIR }}
        run: npm run format -- --check

      - name: ğŸ—ï¸ Build TypeScript
        working-directory: ${{ env.BACKEND_DIR }}
        run: npm run build

      - name: ğŸ§ª Run tests with coverage
        working-directory: ${{ env.BACKEND_DIR }}
        run: npm run test:coverage
        env:
          NODE_ENV: test

      - name: ğŸ“Š SonarQube Scan
        uses: SonarSource/sonarqube-scan-action@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  quality-gate:
    name: Quality Gate Check
    runs-on: ubuntu-latest
    needs: sonarqube
    if: always()
    
    steps:
    - name: ğŸ“Š Check Quality Gate
      uses: SonarSource/sonarqube-quality-gate-action@v1.0.2
      env:
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      continue-on-error: true

  notify:
    name: Notify Analysis Results
    runs-on: ubuntu-latest
    needs: [sonarqube, quality-gate]
    if: always()
    
    steps:
      - name: ğŸ“¢ Notify success
        if: needs.sonarqube.result == 'success' && needs.quality-gate.result == 'success'
        run: |
          echo "âœ… SonarQube analysis completed successfully!"
          echo "ğŸ” Quality Gate: PASSED"
          echo "ğŸ“Š Coverage: Generated"
          echo "ğŸ¯ Code Quality: Excellent"

      - name: ğŸ“¢ Notify failure
        if: needs.sonarqube.result == 'failure' || needs.quality-gate.result == 'failure'
        run: |
          echo "âŒ SonarQube analysis failed!"
          echo "ğŸ” Quality Gate: ${{ needs.quality-gate.result }}"
          echo "ğŸ“Š Analysis: ${{ needs.sonarqube.result }}"
          echo "ğŸ’¡ Check SonarCloud dashboard for details"
          exit 1
